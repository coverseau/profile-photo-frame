<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="Web application overlaying a vaccine injury photo frame onto a social media profile photo.">
		<meta name="author" content="Rado Faletič">
		<meta name="keywords" content="photo, image, photo frame, social media">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

		<style>
			section {
				margin-top: 3rem;
			}
			footer {
				margin-top: 5rem;
			}
		</style>
		<title>#CanWeTalkAboutIt profile photo frame</title>
	</head>
	
	<body class="container text-center">
		
		<header>
			<h1 class="display-1"><mark>#CanWeTalkAboutIt</mark><br> profile photo frame</h1>
		</header>
		
		<main>
			<p>Use this page to create a frame for your social media photo in three simple steps.</p>
			<p>To learn more about the <mark>#CanWeTalkAboutIt</mark> campaign, visit <a href="https://canwetalkaboutit.org/">canwetalkaboutit.org</a>.</p>
			
			<section>
				<h2>Step 1: upload photo (needs to be square)</h2>
				<p><input type="file" id="ppf_selectOriginalPhoto" accept="image/*" class="d-none"><button id="ppf_selectPhoto" type="button" class="btn btn-secondary">select photo</button></p>
				<div id="ppf_originalPhotoDisplay_block">
					<canvas id="ppf_originalPhotoDisplay" style="background-color: transparent; background-image: url('templates/placeholder.svg'); background-repeat: no-repeat; background-size: 200px 200px; background-position: center center; background-attachment: local; background-origin: content-box; opacity: 0.25;" width="200" height="200" class="d-inline" data-photo="">
						Your browser does not support the features of this website.
					</canvas>
				</div>
			</section>
			
			<section>
				<h2 id="ppf_templateList_heading">Step 2: select a template</h2>
				<div>
					<ul id="ppf_templateList" class="list-inline"></ul>
				</div>
			</section>
			
			<section>
				<h2>Step 3: view and download your new profile photo</h2>
				<canvas id="ppf_newPhotoDisplay" width="300" height="300" class="d-inline" >
					Your browser does not support the features of this website.
				</canvas>
				<p><button id="ppf_downloadPhoto" type="button" class="btn btn-secondary" style="display: none;">download photo above</button>&nbsp;</p>
			</section>
			
			<canvas id="ppf_newPhotoDownload" width="800" height="800" class="d-none">
				Your browser does not support the features of this website.
			</canvas>
		</main>
		
		<footer class="d-none">
			<p class="container">© 2022 Rado Faletič</p>
		</footer>
		
<script>
window.onload = () => {
	ppf_preparePhotoLoad();
	ppf_prepareTemplateSelect();
	ppf_prepareDownloadButton();
};

function ppf_preparePhotoLoad() {
	const selectPhotoFile = document.getElementById('ppf_selectOriginalPhoto');
	document.getElementById('ppf_originalPhotoDisplay').onclick = () => {
		selectPhotoFile.click();
	}
	document.getElementById('ppf_selectPhoto').onclick = () => {
		selectPhotoFile.click();
	}
	selectPhotoFile.onchange = () => {
		const originalPhotoDisplay = document.getElementById('ppf_originalPhotoDisplay');
		const context = originalPhotoDisplay.getContext('2d');
		
		// clear any existing images
		context.clearRect(0, 0, originalPhotoDisplay.width, originalPhotoDisplay.height);
		originalPhotoDisplay.style.opacity = 0.25;
		originalPhotoDisplay.setAttribute('data-photo', '');
		
		// load new image
		let cWidth = 200, cHeight = 200;
		originalPhotoDisplay.width = cWidth;
		originalPhotoDisplay.height = cHeight;
		if (selectPhotoFile.files && selectPhotoFile.files.length && selectPhotoFile.files[0]) {
			const photoFile = selectPhotoFile.files[0];
			originalPhotoDisplay.style.backgroundImage = 'none';
			originalPhotoDisplay.style.opacity = 1.0;
			const originalImage = new Image();
			originalImage.src = window.URL.createObjectURL(photoFile);
			originalImage.onload = () => {
				/*
				// if the image isn't square, we need to crop it
				if (originalImage.naturalWidth != 0 && originalImage.naturalWidth != originalImage.naturalHeight) {
					const ratio = Math.max(originalImage.naturalWidth, originalImage.naturalHeight) / Math.min(originalImage.naturalWidth, originalImage.naturalHeight);
					if (originalImage.naturalWidth > originalImage.naturalHeight) {
						cWidth = Math.round(originalPhotoDisplay.width * ratio);
						originalPhotoDisplay.width = cWidth;
					} else if (originalImage.naturalWidth < originalImage.naturalHeight) {
						cHeight = Math.round(originalPhotoDisplay.height * ratio);
						originalPhotoDisplay.height = cHeight;
					}
					const originalPhotoDiv = document.getElementById('ppf_originalPhotoDisplay_block');
					// ... add features here to perform crop
				}
				*/
				context.drawImage(originalImage, 0, 0, cWidth, cHeight);
				originalPhotoDisplay.setAttribute('data-photo', photoFile.name);
				window.URL.revokeObjectURL(originalImage.src);
				ppf_doOverlay();
			};
		} else {
			originalPhotoDisplay.style.backgroundImage = 'url(\'templates/placeholder.svg\')';
			originalPhotoDisplay.width = 200;
			originalPhotoDisplay.height = 200;
			originalPhotoDisplay.style.opacity = 0.25;
		}
		
	}
}

function ppf_prepareTemplateSelect() {
	const templates = ['CanWeTalkAboutIt', 'IStandWithYou'];
	const heading = document.getElementById('ppf_templateList_heading');
	heading.innerText = heading.innerText + ' (' + templates.length + ' to choose from)';
	const listParent = document.getElementById('ppf_templateList');
	templates.forEach(template => {
		const listItem = document.createElement('li');
		listItem.id = 'ppf_template_' + template;
		listItem.setAttribute('data-template', template);
		listItem.setAttribute('data-selected', 'false');
		listItem.classList.add('list-inline-item');
		listItem.classList.add('border');
		listItem.classList.add('border-4');
		listItem.classList.add('border-secondary');
		listItem.style.cursor = 'pointer';
		listItem.onmouseover = () => {
			listItem.style.outline = '4px var(--bs-border-style) var(--bs-secondary)';
		};
		listItem.onmouseout = () => {
			listItem.style.outline = 'none';
		};
		listItem.onclick = () => {
			listItem.style.outlineColor = 'var(--bs-warning)';
			templates.forEach(template2 => {
				const template2el = document.getElementById('ppf_template_' + template2);
				template2el.setAttribute('data-selected', 'false');
				template2el.classList.remove('shadow-lg');
				template2el.classList.remove('border-warning');
				template2el.classList.add('border-secondary');
			});
			listItem.setAttribute('data-selected', 'true');
			listItem.classList.add('border-warning');
			listItem.classList.add('shadow-lg');
			ppf_doOverlay();
		};
		
		const imageItem = document.createElement('img');
		imageItem.height = 200;
		imageItem.width = 200;
		imageItem.classList.add('m-0');
		imageItem.classList.add('p-0');
		imageItem.style.backgroundColor = '#afc6c6';
		imageItem.style.backgroundImage = 'url(\'templates/placeholder.svg\')';
		imageItem.style.backgroundRepeat = 'no-repeat';
		imageItem.style.backgroundPosition = 'center center';
		imageItem.style.backgroundAttachment = 'local';
		imageItem.style.backgroundOrigin = 'content-box';
		imageItem.style.backgroundSize = '200px 200px';
		
		imageItem.src = 'templates/' + template + '.svg';
		imageItem.alt = template;
		
		listItem.appendChild(imageItem);
		listParent.appendChild(listItem);
	});
}

function ppf_doOverlay() {
	const newPhotoDisplay = document.getElementById('ppf_newPhotoDisplay');
	const context = newPhotoDisplay.getContext('2d');
	context.clearRect(0, 0, newPhotoDisplay.width, newPhotoDisplay.height);
	const downloadButton = document.getElementById('ppf_downloadPhoto');
	downloadButton.style.display = 'none';
	
	const originalPhotoDisplay = document.getElementById('ppf_originalPhotoDisplay');
	let goAhead = '';
	if (originalPhotoDisplay.getAttribute('data-photo').length) {
		const listParent = document.getElementById('ppf_templateList');
		listParent.childNodes.forEach(listItem => {
			if (listItem.getAttribute('data-selected') == 'true') {
				goAhead = listItem.getAttribute('data-template');
			}
		});
	}
	if (goAhead.length) {
		const selectPhotoFile = document.getElementById('ppf_selectOriginalPhoto');
		const photoFile = selectPhotoFile.files[0];
		const originalImage = new Image();
		originalImage.src = window.URL.createObjectURL(photoFile);
		originalImage.onload = () => {
			context.drawImage(originalImage, 0, 0, 300, 300);
			window.URL.revokeObjectURL(originalImage.src);
			const overlayImage = new Image();
			overlayImage.src = 'templates/' + goAhead + '.svg';
			overlayImage.onload = () => {
				context.drawImage(overlayImage, 0, 0, 300, 300);
				downloadButton.style.display = 'inline';
			};
		};
	}
}

function ppf_prepareDownloadButton() {
	/*
	document.getElementById('ppf_newPhotoDisplay').onclick = () => {
		document.getElementById('ppf_downloadPhoto').click();
	};
	*/
	document.getElementById('ppf_downloadPhoto').onclick = () => {
		const newPhotoDownload = document.getElementById('ppf_newPhotoDownload');
		const context = newPhotoDownload.getContext('2d');
		context.clearRect(0, 0, newPhotoDownload.width, newPhotoDownload.height);
		newPhotoDownload.width = 800;
		newPhotoDownload.height = 800;
		
		const originalPhotoDisplay = document.getElementById('ppf_originalPhotoDisplay');
		let goAhead = '';
		if (originalPhotoDisplay.getAttribute('data-photo').length) {
			const listParent = document.getElementById('ppf_templateList');
			listParent.childNodes.forEach(listItem => {
				if (listItem.getAttribute('data-selected') == 'true') {
					goAhead = listItem.getAttribute('data-template');
				}
			});
		}
		if (goAhead.length) {
			const selectPhotoFile = document.getElementById('ppf_selectOriginalPhoto');
			const photoFile = selectPhotoFile.files[0];
			const originalImage = new Image();
			originalImage.src = window.URL.createObjectURL(photoFile);
			originalImage.onload = () => {
				let minDim = Math.min(originalImage.naturalWidth, originalImage.naturalHeight);
				newPhotoDownload.width = minDim;
				newPhotoDownload.height = minDim;
				const overlayImage = new Image();
				overlayImage.src = 'templates/' + goAhead + '.svg';
				overlayImage.onload = () => {
					context.drawImage(originalImage, 0, 0, minDim, minDim);
					window.URL.revokeObjectURL(originalImage.src);
					context.drawImage(overlayImage, 0, 0, minDim, minDim);
					const link = document.createElement('a');
					link.download = 'new profile photo.jpg';
					link.href = context.canvas.toDataURL('image/jpeg');
					link.click();
					link.remove();
				};
			};
		}
	};
}
</script>
	</body>
</html>
